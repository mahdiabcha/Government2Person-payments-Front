import { Component, ElementRef, ViewChild } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule, ReactiveFormsModule, FormBuilder, Validators, AbstractControl, ValidationErrors } from '@angular/forms';
import { MatCardModule } from '@angular/material/card';
import { MatFormFieldModule } from '@angular/material/form-field';
import { MatInputModule } from '@angular/material/input';
import { MatButtonModule } from '@angular/material/button';
import { MatRadioModule } from '@angular/material/radio';
import { Router, RouterLink } from '@angular/router';
import { MatSnackBar, MatSnackBarModule } from '@angular/material/snack-bar';
import { AuthService } from '../core/auth.service';
import { MatIconModule } from '@angular/material/icon';
import { MatProgressSpinnerModule } from '@angular/material/progress-spinner';
import { MatDividerModule } from '@angular/material/divider';
import { MatTooltipModule } from '@angular/material/tooltip';
import { MatProgressBarModule } from '@angular/material/progress-bar';

function passwordsMatch(group: AbstractControl): ValidationErrors | null {
  const p = group.get('password')?.value || '';
  const c = group.get('confirm')?.value || '';
  return p === c ? null : { mismatch: true };
}

@Component({
  standalone: true,
  selector: 'app-signup',
  imports: [
    CommonModule, FormsModule, ReactiveFormsModule,
    MatCardModule, MatFormFieldModule, MatInputModule, MatButtonModule,
    MatSnackBarModule, MatRadioModule, RouterLink, MatIconModule,
    MatProgressSpinnerModule, MatDividerModule, MatTooltipModule, MatProgressBarModule
  ],
  styles: [`
    .bg {
      min-height: 100vh; display:flex; align-items:center; justify-content:center;
      background:
        radial-gradient(1200px 200px at -10% -40%, rgba(59,130,246,.12), transparent 60%),
        radial-gradient(1200px 200px at 110% 140%, rgba(16,185,129,.12), transparent 60%),
        #f8fafc;
      padding: 2rem;
    }
    mat-card { padding: 1.25rem 1.25rem .75rem; }
    .sub { color:#64748b; }
    .error-banner {
      border: 1px solid rgba(239,68,68,.35);
      background: rgba(239,68,68,.08);
      color: #b91c1c;
      padding: .5rem .75rem; border-radius: .5rem;
      margin-bottom: .75rem;
      font-size: .875rem;
    }
    .hint-list { font-size:.75rem; color:#64748b; margin:.25rem 0 .25rem; }
    .hint-list .ok { color:#059669; }
    .caps { color:#b45309; font-size:.75rem; display:flex; align-items:center; gap:.25rem; }
  `],
  template: `
    <div class="bg">
      <mat-card class="w-full max-w-md">
        <div class="flex items-center gap-2 mb-1">
          <mat-icon>person_add</mat-icon>
          <h2 class="text-xl font-semibold m-0">Create your account</h2>
        </div>
        <div class="text-sm sub mb-3">OpenG2P Portal</div>

        <div *ngIf="serverError" class="error-banner">
          {{ serverError }}
        </div>

        <form [formGroup]="form" (ngSubmit)="submit()" novalidate>
          <mat-form-field appearance="outline" class="w-full mb-3">
            <mat-label>Username</mat-label>
            <input matInput formControlName="username" autocomplete="username" autofocus />
            <mat-hint>3â€“32 chars: letters, numbers, dot, underscore.</mat-hint>
            <mat-error *ngIf="fc.username.hasError('required')">Username is required.</mat-error>
            <mat-error *ngIf="fc.username.hasError('pattern')">Invalid username format.</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="w-full mb-3">
            <mat-label>National ID (8 digits)</mat-label>
            <input matInput formControlName="nationalId" inputmode="numeric" autocomplete="off" />
            <mat-error *ngIf="fc.nationalId.hasError('required')">National ID is required.</mat-error>
            <mat-error *ngIf="fc.nationalId.hasError('pattern')">Must be exactly 8 digits.</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="w-full mb-1">
            <mat-label>Password</mat-label>
            <input matInput [type]="showPass ? 'text' : 'password'"
                   formControlName="password" autocomplete="new-password"
                   (keydown)="caps1 = ($event as KeyboardEvent).getModifierState?.('CapsLock')"
                   (keyup)="caps1 = ($event as KeyboardEvent).getModifierState?.('CapsLock')" />
            <button mat-icon-button matSuffix type="button"
                    (click)="showPass=!showPass"
                    [attr.aria-label]="showPass?'Hide password':'Show password'">
              <mat-icon>{{ showPass ? 'visibility_off' : 'visibility' }}</mat-icon>
            </button>
            <mat-hint>
              Min 8 chars, at least one letter & number.
            </mat-hint>
            <mat-error *ngIf="fc.password.hasError('required')">Password is required.</mat-error>
            <mat-error *ngIf="fc.password.hasError('pattern')">Use 8+ chars with letters & numbers.</mat-error>
          </mat-form-field>

          <div class="hint-list" [class.ok]="strength.score>=3">
            Strength: <b>{{ strength.label }}</b>
            <mat-progress-bar [value]="strength.percent" [color]="strength.color" style="margin:.25rem 0;"></mat-progress-bar>
          </div>
          <div *ngIf="caps1" class="caps"><mat-icon inline>keyboard_capslock</mat-icon> Caps Lock is ON</div>

          <mat-form-field appearance="outline" class="w-full mb-2">
            <mat-label>Confirm password</mat-label>
            <input matInput [type]="showConfirm ? 'text' : 'password'"
                   formControlName="confirm" autocomplete="new-password"
                   (keydown)="caps2 = ($event as KeyboardEvent).getModifierState?.('CapsLock')"
                   (keyup)="caps2 = ($event as KeyboardEvent).getModifierState?.('CapsLock')" />
            <button mat-icon-button matSuffix type="button"
                    (click)="showConfirm=!showConfirm"
                    [attr.aria-label]="showConfirm?'Hide password':'Show password'">
              <mat-icon>{{ showConfirm ? 'visibility_off' : 'visibility' }}</mat-icon>
            </button>
            <mat-error *ngIf="form.hasError('mismatch')">Passwords do not match.</mat-error>
          </mat-form-field>
          <div *ngIf="caps2" class="caps"><mat-icon inline>keyboard_capslock</mat-icon> Caps Lock is ON</div>

          <div class="mb-3">
            <label class="text-sm block mb-1">Sign up as</label>
            <mat-radio-group formControlName="role" class="flex gap-6">
              <mat-radio-button value="CITIZEN">Citizen</mat-radio-button>
              <mat-radio-button value="AGENT" matTooltip="Admins can access management features">Agent (Admin)</mat-radio-button>
            </mat-radio-group>
          </div>

          <button mat-raised-button color="primary" class="w-full"
                  [disabled]="form.invalid || loading">
            <ng-container *ngIf="!loading; else spin">Sign up</ng-container>
            <ng-template #spin>
              <mat-progress-spinner mode="indeterminate" diameter="16"></mat-progress-spinner>
            </ng-template>
          </button>
        </form>

        <div class="text-xs text-red-600 mt-2" *ngIf="form.hasError('mismatch')">Passwords do not match.</div>

        <mat-divider class="my-3"></mat-divider>

        <div class="text-sm mt-2 text-center">
          Already have an account?
          <a routerLink="/login" class="text-emerald-700 font-medium hover:underline">Login</a>
        </div>
      </mat-card>
    </div>
  `,
})
export class SignupPage {
  form = this.fb.group({
    username: ['', [Validators.required, Validators.pattern(/^[a-zA-Z0-9._-]{3,32}$/)]],
    nationalId: ['', [Validators.required, Validators.pattern(/^\d{8}$/)]],
    password: ['', [Validators.required, Validators.pattern(/^(?=.*[A-Za-z])(?=.*\d).{8,}$/)]],
    confirm: ['', Validators.required],
    role: ['CITIZEN' as 'CITIZEN' | 'AGENT', Validators.required],
  }, { validators: passwordsMatch });

  loading = false;
  showPass = false;
  showConfirm = false;
  caps1 = false;
  caps2 = false;
  serverError = '';

  @ViewChild('usernameInput') usernameEl?: ElementRef<HTMLInputElement>;
  get fc() { return this.form.controls as any; }

  constructor(private fb: FormBuilder, private auth: AuthService, private router: Router, private snack: MatSnackBar) {}

  get strength() {
    const v: string = this.fc.password.value || '';
    let score = 0;
    if (v.length >= 8) score++;
    if (/[A-Z]/.test(v)) score++;
    if (/[a-z]/.test(v)) score++;
    if (/\d/.test(v)) score++;
    if (/[^A-Za-z0-9]/.test(v)) score++; // special
    const clamp = Math.min(score, 5);
    const percent = [0, 20, 40, 60, 85, 100][clamp];
    const label = ['Empty','Very weak','Weak','Fair','Good','Strong'][clamp];
    const color: 'primary' | 'accent' | 'warn' = clamp <= 2 ? 'warn' : (clamp === 3 ? 'accent' : 'primary');
    return { score: clamp, percent, label, color };
  }

  submit() {
    this.serverError = '';
    if (this.form.invalid || this.loading) {
      this.form.markAllAsTouched();
      return;
    }
    const { username, password, nationalId, role } = this.form.value as any;
    const payload = {
      username: (username || '').trim(), // if usernames are case-insensitive, you can use .toLowerCase()
      password: password || '',
      nationalId: (nationalId || '').trim(),
      role
    };
    this.loading = true;
    this.auth.signup(payload).subscribe({
      next: () => {
        this.loading = false;
        this.snack.open('Account created. Please login.', 'Close', { duration: 1800 });
        this.router.navigateByUrl('/login');
      },
      error: (err) => {
        this.loading = false;
        this.serverError = (err?.error?.message || err?.message || 'Signup failed. Please check your details and try again.');
      }
    });
  }
}
